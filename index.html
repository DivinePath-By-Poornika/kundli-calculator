<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lightweight Kundli (Offline · No API)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config={theme:{extend:{colors:{primary:'#7c3aed',panel:'#0b1220'},boxShadow:{soft:'0 10px 30px rgba(0,0,0,.12)'}}}};
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji"}
    .chart{position:relative;width:100%;aspect-ratio:1/1}
    .chart .diamond{position:absolute;inset:0;transform:rotate(45deg);border:2px solid #20304a;border-radius:14px;background:linear-gradient(180deg,#0a1220,#0a1322)}
    .grid-12{display:grid;grid-template-columns:repeat(6,1fr);grid-template-rows:repeat(6,1fr);position:absolute;inset:0}
    .grid-12>div{display:flex;align-items:center;justify-content:center;padding:4px}
    .house{width:100%;height:100%;border:1px solid #233047;border-radius:10px;background:#0c1626cc;backdrop-filter:blur(3px)}
    .tag{display:inline-flex;gap:.35rem;align-items:center;padding:2px 8px;border-radius:999px;background:#0f172a;border:1px solid #243246;font-size:11px;margin:2px}
    .label{font-size:10px;color:#9aa7bd}
    .mono{font-variant-numeric:tabular-nums}
  </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
  <div class="max-w-6xl mx-auto p-4 md:p-8">
    <header class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-6">
      <div>
        <h1 class="text-3xl md:text-4xl font-extrabold">⚝ Lightweight Kundli — Offline</h1>
        <p class="text-slate-400">Ye version bina API ke **browser me hi** calculate karta hai. Accuracy: D1 chart ke liye kaafi achchi (Sun/Moon ✔, Lagna ✔). Planets simplified orbits se nikle jaate hain.</p>
      </div>
      <div class="flex gap-2 items-center"><span class="tag">No API</span><span class="tag">Single file</span><span class="tag">North‑Indian chart</span></div>
    </header>

    <section class="bg-slate-900/40 border border-slate-800 rounded-2xl p-4 md:p-6 shadow-soft mb-6">
      <h2 class="text-lg font-semibold mb-3">Birth Details</h2>
      <form id="form" class="grid md:grid-cols-5 gap-4">
        <label class="block md:col-span-2">
          <span class="text-sm text-slate-300">Date of Birth</span>
          <input id="dob" type="date" class="mt-1 w-full bg-slate-900 border border-slate-700 rounded-xl px-3 py-2" required>
        </label>
        <label class="block">
          <span class="text-sm text-slate-300">Time of Birth</span>
          <input id="tob" type="time" step="60" class="mt-1 w-full bg-slate-900 border border-slate-700 rounded-xl px-3 py-2" required>
        </label>
        <label class="block">
          <span class="text-sm text-slate-300">UTC Offset (hours)</span>
          <input id="tz" type="number" step="0.25" class="mt-1 w-full bg-slate-900 border border-slate-700 rounded-xl px-3 py-2" placeholder="5.5" value="5.5" required>
        </label>
        <div class="grid grid-cols-2 gap-4 md:col-span-2">
          <label class="block">
            <span class="text-sm text-slate-300">Latitude (°)</span>
            <input id="lat" type="number" step="0.0001" class="mt-1 w-full bg-slate-900 border border-slate-700 rounded-xl px-3 py-2" placeholder="26.9124" required>
          </label>
          <label class="block">
            <span class="text-sm text-slate-300">Longitude (°)</span>
            <input id="lon" type="number" step="0.0001" class="mt-1 w-full bg-slate-900 border border-slate-700 rounded-xl px-3 py-2" placeholder="75.7873" required>
          </label>
        </div>
        <label class="block">
          <span class="text-sm text-slate-300">Ayanāṁśa</span>
          <select id="ayana" class="mt-1 w-full bg-slate-900 border border-slate-700 rounded-xl px-3 py-2">
            <option value="lahiri" selected>Lahiri (approx)</option>
            <option value="tropical">Tropical (Western)</option>
          </select>
        </label>
        <div class="flex items-end gap-3">
          <button type="button" id="geoBtn" class="px-4 py-2 rounded-xl bg-primary/90 hover:bg-primary">Use current location</button>
          <button type="submit" class="px-4 py-2 rounded-xl bg-emerald-400 text-slate-900 font-semibold">Generate</button>
        </div>
      </form>
      <p class="text-xs text-slate-500 mt-3">Tip: Birth place ka **UTC offset** (DST agar tha to) sahi bharein. India ke liye usually 5.5.</p>
    </section>

    <section class="grid lg:grid-cols-2 gap-6">
      <div class="bg-slate-900/40 border border-slate-800 rounded-2xl p-4 md:p-6 shadow-soft">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold">D1 Rāśi Chart (North‑Indian)</h2>
          <div class="flex gap-2 items-center">
            <span id="ascTag" class="tag">Lagna: —</span>
            <span id="ayanTag" class="tag">Ayanāṁśa: —</span>
          </div>
        </div>
        <div class="chart">
          <div class="diamond"></div>
          <div id="grid" class="grid-12"></div>
        </div>
        <p class="text-xs text-slate-500 mt-2">Note: Ye lightweight calculator approx planetary orbits use karta hai. Lagna & Surya‑Chandra high accuracy hain; baaki grah ~±1–2° typical.</p>
      </div>
      <div class="bg-slate-900/40 border border-slate-800 rounded-2xl p-4 md:p-6 shadow-soft">
        <h2 class="text-lg font-semibold mb-2">Graha Positions</h2>
        <div id="planetList" class="flex flex-wrap"></div>
        <h3 class="text-sm text-slate-300 mt-4 mb-1">Debug</h3>
        <pre id="debug" class="bg-black/40 border border-slate-800 rounded-xl p-3 overflow-auto text-xs max-h-80"></pre>
      </div>
    </section>

    <footer class="text-xs text-slate-500 mt-10 text-center">Made for you — single file, no internet required.</footer>
  </div>

  <script>
    // ---------- Utilities ----------
    const D2R = Math.PI/180, R2D = 180/Math.PI;
    const norm360 = x => (x%360+360)%360;
    const sin = d=>Math.sin(d*D2R), cos=d=>Math.cos(d*D2R), tan=d=>Math.tan(d*D2R), atan2=(y,x)=>Math.atan2(y,x)*R2D;

    function jdFromYMDhms(y,m,dd,hh,mm,ss){
      if(m<=2){ y-=1; m+=12; }
      const A = Math.floor(y/100);
      const B = 2 - A + Math.floor(A/4);
      const day = dd + (hh + (mm + ss/60)/60)/24;
      return Math.floor(365.25*(y+4716)) + Math.floor(30.6001*(m+1)) + day + B - 1524.5;
    }
    function gmstFromJD(JD){
      const T = (JD-2451545.0)/36525;
      let GMST = 280.46061837 + 360.98564736629*(JD-2451545) + 0.000387933*T*T - T*T*T/38710000;
      return norm360(GMST);
    }
    function obliquityMean(T){
      // arcseconds -> degrees
      const sec = 21.448 - 46.8150*T - 0.00059*T*T + 0.001813*T*T*T; // 23°26'...
      return 23 + 26/60 + sec/3600;
    }

    // Rough Lahiri ayanamsa (good to ~0.2°). Reference ~ 23.853° @ J2000, drift ~ 50.290966''/yr
    function ayanamsaLahiri(JD){
      const years = (JD - 2451545.0)/365.2422; // from J2000.0
      const base = 23.8530556; // degrees at J2000 (approx 23°51'11")
      const drift = (50.290966/3600) * years; // deg per year
      return base + drift; // ~24.1° around 2025
    }

    // Local Sidereal & Ascendant
    function ascendantLongitude(JD, latDeg, lonDeg){
      const T = (JD-2451545.0)/36525;
      const eps = obliquityMean(T);
      const GMST = gmstFromJD(JD);
      const LST = norm360(GMST + lonDeg);
      const theta = LST*D2R, phi = latDeg*D2R, epsR = eps*D2R;
      const num = -Math.cos(theta);
      const den = Math.sin(theta)*Math.cos(epsR) + Math.tan(phi)*Math.sin(epsR);
      let lambda = Math.atan2(num, den)*R2D; // degrees
      lambda = norm360(lambda);
      return lambda;
    }

    // Sun (tropical) — Meeus low-precision
    function sunLongitude(JD){
      const T = (JD - 2451545.0)/36525;
      const L0 = 280.46646 + 36000.76983*T + 0.0003032*T*T; // mean longitude
      const M  = 357.52911 + 35999.05029*T - 0.0001537*T*T; // mean anomaly
      const C = (1.914602 - 0.004817*T - 0.000014*T*T)*sin(M)
              + (0.019993 - 0.000101*T)*sin(2*M)
              + 0.000289*sin(3*M);
      const trueLong = L0 + C; // degrees
      return norm360(trueLong);
    }

    // Moon (tropical) — simple series (good to ~0.5°)
    function moonLongitude(JD){
      const T = (JD - 2451545.0)/36525;
      const Lp = 218.3164477 + 481267.88123421*T - 0.0015786*T*T + (T*T*T)/538841 - (T*T*T*T)/65194000;
      const D  = 297.8501921 + 445267.1114034*T - 0.0018819*T*T + (T*T*T)/545868 - (T*T*T*T)/113065000;
      const M  = 357.5291092 + 35999.0502909*T - 0.0001536*T*T + (T*T*T)/24490000;
      const Mp = 134.9633964 + 477198.8675055*T + 0.0087414*T*T + (T*T*T)/69699 - (T*T*T*T)/14712000;
      const F  = 93.2720950  + 483202.0175233*T - 0.0036539*T*T - (T*T*T)/3526000 + (T*T*T*T)/863310000;
      // very small set of terms
      let lon = Lp
        + 6.289 * sin(Mp)
        + 1.274 * sin(2*D - Mp)
        + 0.658 * sin(2*D)
        + 0.213 * sin(2*Mp)
        - 0.185 * sin(M)
        - 0.114 * sin(2*F);
      return norm360(lon);
    }

    // Very lightweight approximate longitudes for visible planets (tropical)
    // Using mean motions around J2000; good mostly for sign / house placement.
    function approxPlanetLongitude(JD, planet){
      const days = JD - 2451545.0;
      // Mean longitudes at J2000 (deg) + mean daily motion (deg/day) — coarse
      const map = {
        Mercury: { L0: 252.25084, n: 4.09233445 }, // 360/87.969
        Venus:   { L0: 181.97973, n: 1.60213034 }, // 360/224.701
        Mars:    { L0: 355.43300, n: 0.524039  },  // 360/686.98
        Jupiter: { L0: 34.351484, n: 0.083091  },  // 360/4332.59
        Saturn:  { L0: 50.077471, n: 0.033497  }   // 360/10759.22
      };
      const p = map[planet];
      if(!p) return 0;
      return norm360(p.L0 + p.n * days);
    }

    // Rahu/Ketu (tropical) from mean node of the Moon
    function meanNodeLongitude(JD){
      const T = (JD - 2451545.0)/36525;
      let Omega = 125.04452 - 1934.136261*T + 0.0020708*T*T + (T*T*T)/450000; // deg
      return norm360(Omega);
    }

    // ---------- Vedic helpers ----------
    const SIGNS = ['Aries','Taurus','Gemini','Cancer','Leo','Virgo','Libra','Scorpio','Sagittarius','Capricorn','Aquarius','Pisces'];
    const SIGN_ABBR = ['Ar','Ta','Ge','Cn','Le','Vi','Li','Sc','Sg','Cp','Aq','Pi'];
    const PLANET_ABBR = { Sun:'Su', Moon:'Mo', Mars:'Ma', Mercury:'Me', Jupiter:'Ju', Venus:'Ve', Saturn:'Sa', Rahu:'Ra', Ketu:'Ke', Ascendant:'As' };

    const HOUSE_CELL = {1:[3,1],2:[2,1],3:[1,2],4:[1,3],5:[1,4],6:[2,5],7:[3,5],8:[5,5],9:[6,4],10:[6,3],11:[6,2],12:[5,1]};
    function cellStyle(r,c){return `grid-row:${r};grid-column:${c};`}

    function resetChart(){
      const g=document.getElementById('grid');
      g.innerHTML='';
      for(let h=1;h<=12;h++){
        const [r,c]=HOUSE_CELL[h];
        const el=document.createElement('div');
        el.style=cellStyle(r,c);
        el.innerHTML=`<div class="house p-1"><div class="label">H${h}</div><div id="house-${h}" class="text-xs leading-4"></div></div>`;
        g.appendChild(el);
      }
    }
    function putInHouse(house,text){
      const el=document.getElementById('house-'+house); if(!el) return;
      const span=document.createElement('span'); span.className='tag'; span.textContent=text; el.appendChild(span);
    }

    function toSidereal(tropicalLon, JD, ayanaMode){
      if(ayanaMode==='tropical') return norm360(tropicalLon);
      const ay = ayanamsaLahiri(JD);
      return norm360(tropicalLon - ay);
    }

    function signIndex(lon){ return Math.floor(norm360(lon)/30); }

    function showPlanets(list){
      const wrap=document.getElementById('planetList'); wrap.innerHTML='';
      list.forEach(p=>{
        const div=document.createElement('div'); div.className='tag mono';
        const deg = (p.lon%30).toFixed(2).padStart(5,'0');
        div.textContent=`${PLANET_ABBR[p.name]||p.name}: ${SIGN_ABBR[p.sign]} ${deg}°`;
        wrap.appendChild(div);
      });
    }

    function setDebug(obj){ document.getElementById('debug').textContent = JSON.stringify(obj,null,2); }

    // ---------- Main compute ----------
    function compute(payload){
      // Build JD at UTC from local date/time and offset
      const [Y,M,D] = payload.date.split('-').map(Number);
      const [hh,mm] = payload.time.split(':').map(Number);
      const utcHour = hh - payload.tz; // tz in hours
      // split utcHour into h:m:s safely
      const uh = Math.floor(utcHour);
      const um = Math.round((utcHour-uh)*60);
      const JD = jdFromYMDhms(Y,M,D,uh,um,0);
      const T = (JD-2451545)/36525;

      // Tropical longitudes
      const sunTrop = sunLongitude(JD);
      const moonTrop = moonLongitude(JD);
      const mercTrop = approxPlanetLongitude(JD,'Mercury');
      const venTrop  = approxPlanetLongitude(JD,'Venus');
      const marsTrop = approxPlanetLongitude(JD,'Mars');
      const jupTrop  = approxPlanetLongitude(JD,'Jupiter');
      const satTrop  = approxPlanetLongitude(JD,'Saturn');
      const rahuTrop = meanNodeLongitude(JD); // Rahu as mean node
      const ketuTrop = norm360(rahuTrop + 180);

      const ascTrop  = ascendantLongitude(JD, payload.lat, payload.lon);

      const ay = ayanamsaLahiri(JD);
      const ayLabel = payload.ayana==='tropical' ? '0.00°' : ay.toFixed(2)+'°';
      document.getElementById('ayanTag').textContent = 'Ayanāṁśa: ' + (payload.ayana==='tropical'?'Tropical':`Lahiri ${ayLabel}`);

      // Convert to sidereal if needed
      const toSid = L => toSidereal(L, JD, payload.ayana);
      const ascSid = toSid(ascTrop);
      const list = [
        {name:'Ascendant', lon:ascSid},
        {name:'Sun', lon: toSid(sunTrop)},
        {name:'Moon', lon: toSid(moonTrop)},
        {name:'Mercury', lon: toSid(mercTrop)},
        {name:'Venus', lon: toSid(venTrop)},
        {name:'Mars', lon: toSid(marsTrop)},
        {name:'Jupiter', lon: toSid(jupTrop)},
        {name:'Saturn', lon: toSid(satTrop)},
        {name:'Rahu', lon: toSid(rahuTrop)},
        {name:'Ketu', lon: toSid(ketuTrop)}
      ].map(p=> ({...p, sign: signIndex(p.lon)}));

      return { JD, ay, asc: ascSid, planets:list };
    }

    function render(result){
      resetChart();
      const ascSign = signIndex(result.asc);
      document.getElementById('ascTag').textContent = 'Lagna: ' + SIGN_ABBR[ascSign];
      // place sign labels per house
      for(let h=1;h<=12;h++){
        const sign = (ascSign + (h-1)) % 12; // sign at house h
        putInHouse(h, SIGN_ABBR[sign]);
      }
      // place planets
      result.planets.forEach(p=>{
        const house = ((p.sign - ascSign + 12)%12)+1;
        putInHouse(house, PLANET_ABBR[p.name]||p.name);
      });

      showPlanets(result.planets.filter(p=>p.name!=='Ascendant'));
      setDebug(result);
    }

    // ---------- UI wiring ----------
    function $(id){return document.getElementById(id)}
    $('geoBtn').addEventListener('click',()=>{
      if(!navigator.geolocation){alert('Geolocation not supported');return}
      navigator.geolocation.getCurrentPosition(pos=>{
        $('lat').value = pos.coords.latitude.toFixed(6);
        $('lon').value = pos.coords.longitude.toFixed(6);
        // try current zone
        const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
        if(tz==='Asia/Kolkata') $('tz').value = 5.5;
      },err=>alert(err.message));
    });

    $('form').addEventListener('submit',e=>{
      e.preventDefault();
      const payload={
        date:$('dob').value,
        time:$('tob').value,
        tz: parseFloat($('tz').value),
        lat: parseFloat($('lat').value),
        lon: parseFloat($('lon').value),
        ayana: $('ayana').value
      };
      try{
        const res=compute(payload);
        render(res);
      }catch(err){
        console.error(err); alert('Error: '+err.message);
      }
    });

    // initial chart grid
    resetChart();
  </script>
</body>
</html>
